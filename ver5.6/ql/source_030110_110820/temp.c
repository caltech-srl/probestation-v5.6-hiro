#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>


float therm(unsigned long aczttemp)
{
  int i=1,fflg=0;
  float atemp,tempd;
  float therm_adc[191]= {
  14719.97,  14623.98,  14523.87, 14419.26, 14310.60, 14197.43, 14079.64,
  13957.46,  13830.78,  13699.86, 13564.03, 13423.93, 13279.21, 13129.98,
  12977.05,  12819.16,  12656.98, 12491.39, 12321.52, 12147.12, 11970.21,
  11788.21,  11604.54,  11416.14, 11225.31, 11033.25, 10837.62, 10639.26,
  10439.15,  10238.46,  10033.61,  9830.40,  9624.92,  9418.01,  9213.76,
   9007.14,   8798.81,   8593.22,  8387.90,  8183.80,  7981.09,  7779.41,
   7579.66,   7381.31,   7185.19,  6991.66,  6800.47,  6611.84,  6425.94,
   6242.88,   6063.37,   5886.15,  5713.17,  5543.00,  5376.21,  5213.34,
   5053.43,   4897.74,   4745.16,  4596.10,  4451.01,  4310.31,  4172.63,
   4038.28,   3907.61,   3780.92,  3657.57,  3537.83,  3421.97,  3309.23,
   3199.80,   3093.93,   2990.72,  2891.45,  2795.21,  2701.02,  2611.30,
   2523.92,   2438.98,   2356.60,  2278.10,  2201.17,  2127.13,  2056.06,
   1986.81,   1920.72,   1855.31,  1793.21,  1733.19,  1675.32,  1619.65,
   1566.24,   1513.79,   1463.28,  1414.61,  1367.82,  1322.55,  1278.94,
   1236.91,   1196.19,   1157.09,  1119.21,  1082.72,  1047.48,  1013.53,
    980.73,    949.09,    918.64,   889.10,   860.76,   833.36,   806.89,
    781.23,    756.68,    732.79,   709.88,   687.66,   666.27,   645.59,
    625.61,    606.34,    587.63,   569.63,   552.37,   535.52,   519.25,
    503.72,    488.47,    473.96,   459.73,   446.10,   432.91,   420.17,
    407.71,    395.87,    384.31,   373.21,   362.41,   351.90,   341.86,
    332.11,    322.67,    313.38,   304.54,   296.02,   287.80,   279.73,
    271.97,    264.36,    257.06,   250.08,   243.24,   236.56,   230.19,
    223.98,    217.92,    212.01,   206.43,   200.83,   195.56,   190.44,
    185.47,    180.51,    175.86,   171.37,   166.87,   162.54,   158.41,
    154.36,    150.44,    146.62,   142.92,   139.33,   135.85,   132.45,
    129.16,    125.97,    122.87,   119.85,   116.93,   114.08,   111.32,
    108.64,    106.02,    103.48,   101.00,    98.61,    96.28,    94.01,
     91.81,     89.65 };

   while(i<191 && fflg==0) {
      atemp=(float)aczttemp;
      if (atemp > therm_adc[i]) {
	 fflg=1;
         tempd=(float)i-40.0-(atemp-therm_adc[i])/(therm_adc[i-1]-therm_adc[i]);
      }
      i++;
   }
   return(tempd);
}


float nu_therm(unsigned int adc)
{
   /* 7th-order polynomial fit. This is only vailed between -40 to 60C
    * within 0.1C error.
    *
   int   i;
   float temp1=0.0;
   double x,tempd;
   double a[8]={9.97876953728039e+01, -9.70145913019284e+01, 6.06970842520106e+01,
	      -2.50580927506103e+01,  6.28588122881268e+00,-9.30615626178434e-01,
 	       7.45489621303974e-02, -2.49576495699149e-03};
   x=((float)adc)/1000.0;
   tempd=0.0;
   for (i=7; i>0; i--) {
       tempd=(tempd + a[i])* x;
   }
   temp1=(float)(tempd+a[0]);
   return(temp1);
   */

   /* Stainhart-hart equation fit. Work for -40 to 140C within 0.01C error.
    * 022210 hiro
    *
    */
   float temp1=0.0;
   double x,adcd,R0=100.e+03,adcmax=8192.0;
   double a[3]={9.34360e-04, 2.21363e-04, 1.27121e-07};
   adcd=(double)adc;
   x=R0/(adcmax/adcd-1.0);
   temp1=1./(float)(a[0]+a[1]*log(x)+a[2]*log(x)*log(x)*log(x))-273.;
   //fprintf(stderr,"nu_therm %f\n",temp1);
   return(temp1);

}


